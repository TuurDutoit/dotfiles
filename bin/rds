#! /bin/zsh

set -e

PSQL=$(command -v psql)
MYSQL=$(command -v mysql)

function _urlencode {
    setopt localoptions extendedglob
    input=( ${(s::)1} )
    print ${(j::)input/(#b)([^A-Za-z0-9_.!~*\'\(\)-])/%${(l:2::0:)$(([##16]#match))}}
}

function _prepare_psql {
  if [ -z "$1" ]; then
    echo 'Missing argument: dbname'
    exit 1
  fi

  export RDSHOST="datacamp-services-psql-shared-readreplica.crsd2orwscer.us-east-1.rds.amazonaws.com"
  export PGPASSWORD="$(aws rds generate-db-auth-token --hostname $RDSHOST --port 5432 --region us-east-1 --username iam_replica_user)"
}

function _prepare_mysql {
  export RDSHOST="datacamp-services-shared-readreplica.crsd2orwscer.us-east-1.rds.amazonaws.com"
  export RDSTOKEN="$(aws rds generate-db-auth-token --hostname $RDSHOST --port 3306 --region us-east-1 --username iam_replica_user)"
}

function psql {
  _prepare_psql $@
  $PSQL --host=$RDSHOST -p 5432 "dbname=$1 user=iam_replica_user sslrootcert=$HOME/.ssh/rds-ca-2019-root.pem sslmode=verify-full"
}

function mysql {
  _prepare_mysql $@
  $MYSQL --host=$RDSHOST --port=3306 --ssl-ca=$HOME/.ssh/rds-ca-2019-root.pem --enable-cleartext-plugin --user=iam_replica_user --password=$RDSTOKEN
}

function postico {
  _prepare_psql $@
  PASS=$(_urlencode $PGPASSWORD)
  echo $PASS
  open "postgres://iam_replica_user:$PASS@$RDSHOST/$1"
}

"$@"